<!DOCTYPE html><html lang="zh-cn"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=2"/><meta name="theme-color" content="#222"/><meta http-equiv="X-UA-COMPATIBLE" content="IE=edge,chrome=1"/><meta name="renderer" content="webkit"/><link rel="icon" type="image/ico" sizes="32x32" href="/assets/favicon.ico"/><link rel="apple-touch-icon" sizes="180x180" href="/assets/apple-touch-icon.png"/><link rel="alternate" href="/rss.xml" title="这就是--Potato" type="application/rss+xml"><link rel="alternate" href="/atom.xml" title="这就是--Potato" type="application/atom+xml"><link rel="alternate" type="application/json" title="这就是--Potato" href="https://zhewanyiershinicheng.github.io/feed.json"/><link rel="preconnect" href="https://s4.zstatic.net"/><link rel="preconnect" href="https://at.alicdn.com"/><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Mulish:400,400italic,700,700italic%7CFredericka%20the%20Great:400,400italic,700,700italic%7CNoto%20Serif%20JP:400,400italic,700,700italic%7CNoto%20Serif%20SC:400,400italic,700,700italic%7CInconsolata:400,400italic,700,700italic&display=swap&subset=latin,latin-ext" media="none" onload="this.media&#x3D;&#39;all&#39;"><link rel="stylesheet" href="/css/app.css?v=0.4.17"><link rel="modulepreload" href="/js/chunk-4WOL5AEA.js"></link><link rel="modulepreload" href="/js/chunk-M2OVB55D.js"></link><link rel="modulepreload" href="/js/chunk-OEHKNEWL.js"></link><link rel="modulepreload" href="/js/copy-tex-JCSSB3EK.js"></link><link rel="modulepreload" href="/js/index.esm-H3NZFZ46.js"></link><link rel="modulepreload" href="/js/post-RFOLAXHH.js"></link><link rel="modulepreload" href="/js/quicklink-LPV2RIEA.js"></link><link rel="modulepreload" href="/js/siteInit.js"></link><link rel="preload" href="6833939bly1gicit31ffoj20zk0m8naf.jpg" as="image" fetchpriority="high"><link rel="preload" href="6833939bly1gicit4jrvuj20zk0m8785.jpg" as="image" fetchpriority="high"><link rel="preload" href="6833939bly1giciryrr3rj20zk0m8nhk.jpg" as="image" fetchpriority="high"><link rel="preload" href="6833939bly1gicitcxhpij20zk0m8hdt.jpg" as="image" fetchpriority="high"><link rel="preload" href="6833939bly1gicis081o9j20zk0m8dmr.jpg" as="image" fetchpriority="high"><link rel="preload" href="6833939bly1gicis3attqj20zk0m8k7l.jpg" as="image" fetchpriority="high"><meta name="keywords" content="《舰舰的奇妙冒险》"/><meta name="description" content="bug依旧很多，反正我忍不了"/><link rel="canonical" href="https://zhewanyiershinicheng.github.io/2025/02/15/%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0/"><title>文件上传漏洞</title><meta name="generator" content="Hexo 7.3.0"></head><body itemscope itemtype="http://schema.org/WebPage"><div id="loading"><div class="cat"><div class="body"></div><div class="head"><div class="face"></div></div><div class="foot"><div class="tummy-end"></div><div class="bottom"></div><div class="legs left"></div><div class="legs right"></div></div><div class="paw"><div class="hands left"></div><div class="hands right"></div></div></div></div><div id="container"><header id="header" itemscope itemtype="http://schema.org/WPHeader"><div class="inner"><div id="brand"><div class="pjax"><h1 itemprop="name headline">文件上传漏洞</h1><div class="meta"><span class="item" title="作成日：2025-02-15 22:21:23"><span class="icon"><i class="ic i-calendar"></i></span><span class="text">投稿日</span><time itemprop="dateCreated datePublished" datetime="2025-02-15T22:21:23+08:00">2025-02-15</time></span><span class="item" title="単語数"><span class="icon"><i class="ic i-pen"></i></span><span class="text">単語数</span><span>8.7k</span><span class="text">単語</span></span><span class="item" title="読書の時間"><span class="icon"><i class="ic i-clock"></i></span><span class="text">読書の時間</span><span>8 分</span></span></div></div></div><nav id="nav"><div class="inner"><div class="toggle"><div class="lines" aria-label="ナビゲーションバーの切り替え"><span class="line"></span><span class="line"></span><span class="line"></span></div></div><ul class="menu"><li class="item title"><a href="/" rel="start">chongkai</a></li></ul><ul class="right" id="rightNav"><li class="item theme"><i class="ic i-sun"></i></li><li class="item search"><i class="ic i-search"></i></li></ul></div></nav></div><div class="pjax" id="imgs"><img src="https://7ed.net/bing/api" loading="eager" decoding="async" fetchpriority="high" alt="这就是--Potato"></div></header><div id="waves"><svg class="waves" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 24 150 28" preserveAspectRatio="none" shape-rendering="auto"><defs><path id="gentle-wave" d="M-160 44c30 0 58-18 88-18s 58 18 88 18 58-18 88-18 58 18 88 18 v44h-352z"></path></defs><g class="parallax"><use xlink:href="#gentle-wave" x="48" y="0"></use><use xlink:href="#gentle-wave" x="48" y="3"></use><use xlink:href="#gentle-wave" x="48" y="5"></use><use xlink:href="#gentle-wave" x="48" y="7"></use></g></svg></div><main><div class="inner"><div class="pjax" id="main"><div class="article wrap"><div class="breadcrumb" itemListElement itemscope itemtype="https://schema.org/BreadcrumbList"><i class="ic i-home"></i><span><a href="/">ホーム</a></span><i class="ic i-angle-right"></i><span class="current" itemprop="itemListElement" itemscope="itemscope" itemtype="https://schema.org/ListItem"><a href="/categories/%E6%8A%80%E6%9C%AF/" itemprop="item" rel="index" title="カテゴリ技术"><span itemprop="name">技术<meta itemprop="position" content="0"/></span></a></span></div><article class="post block" itemscope="itemscope" itemtype="http://schema.org/Article" lang="zh-cn"><link itemprop="mainEntityOfPage" href="https://zhewanyiershinicheng.github.io/2025/02/15/%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0/"/><span hidden="hidden" itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="image" content="/assets/avatar.jpg"/><meta itemprop="name" content="开船的"/><meta itemprop="description" content="真的假的？, bug依旧很多，反正我忍不了"/></span><span hidden="hidden" itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="这就是--Potato"/></span><div class="body md" itemprop="articleBody"><h1 id="文件"><a class="anchor" href="#文件">#</a> 文件</h1>
<h2 id="奇怪的要求~"><a class="anchor" href="#奇怪的要求~">#</a> 奇怪的要求～</h2>
<p>1、请大家写一个文件上传的表单，用于向服务端上传文件，并用 php 作为后端，抓包分析这个请求体的结构是什么样的呢？</p>
<pre><code class="language-php+HTML">&lt;!-- 前端表单 --&gt;
&lt;form action=&quot;upload.php&quot; method=&quot;post&quot; enctype=&quot;multipart/form-data&quot;&gt;
    &lt;input type=&quot;file&quot; name=&quot;myfile&quot;&gt;
    &lt;input type=&quot;submit&quot;&gt;
&lt;/form&gt;

&lt;!-- PHP后端 upload.php --&gt;
&lt;?php
move_uploaded_file($_FILES['myfile']['tmp_name'], 'uploads/'.$_FILES['myfile']['name']);
</code></pre>
<blockquote>
<p>对于前端的部分:</p>
<p>action=&quot;upload.php&quot; 是将数据提交到目标 url，由该 php 文件处理（也就是说要注意路径可以绝对可以相对，如在上级，可用../upload.php）</p>
<p>enctype=&quot;multipart/form-data&quot; 是指定传输过程中的编码类型</p>
<p>其中包括：</p>
<p>application/x-www-form-urlencoded</p>
<p>使用 url 编码，是默认的方式，只能文本数据，存在于 HTTP 请求体</p>
<p>multipart/form-data</p>
<p>上传文件必用，会把数据分为多个部分（文本或二进制，所以非文本都是使用二进制文件，不能使用其他编码方式）</p>
<p>text/plain</p>
<p>纯文本传输，原始格式不变，键值间等号连接，没有封装或编码</p>
</blockquote>
<blockquote>
<p>对于后端的部分:</p>
<p>move_uploaded_file()</p>
<p>是 php 内置函数，移动文件，接受俩参数</p>
<p><code>$_FILES['myfile']['tmp_name']</code> ：</p>
<p>$_FILES 是超全局数组，用于处理上传的文件。</p>
<p><strong>myfile 是 name 属性值</strong>。</p>
<p><code>['tmp_name']</code>  是<strong>临时存储路径</strong>。</p>
<p><code>['name']</code>  是<strong>文件名</strong></p>
<p>(不只这个键，但键是固定的，不是按照实际填，它是返回实际)</p>
<p>后面一个参数通过拼接字符串构造要移动到的<strong>路径</strong></p>
</blockquote>
<figure class="highlight http"><figcaption data-lang="HTTP"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token request-line"><span class="token method property">POST</span> <span class="token request-target url">/upload.php</span> <span class="token http-version property">HTTP/1.1</span></span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token header"><span class="token header-name keyword">Content-Type</span><span class="token punctuation">:</span> <span class="token header-value">multipart/form-data; boundary=----WebKitFormBoundaryABC123</span></span></pre></td></tr><tr><td data-num="3"></td><td><pre></pre></td></tr><tr><td data-num="4"></td><td><pre>------WebKitFormBoundaryABC123</pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token header"><span class="token header-name keyword">Content-Disposition</span><span class="token punctuation">:</span> <span class="token header-value">form-data; name="myfile"; </span></span></pre></td></tr><tr><td data-num="6"></td><td><pre>//头部字段，前一个表示是表单数据</pre></td></tr><tr><td data-num="7"></td><td><pre>filename="test.txt"   //原始文件名</pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token header"><span class="token header-name keyword">Content-Type</span><span class="token punctuation">:</span> <span class="token header-value">text/plain</span></span></pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token text-plain"></pre></td></tr><tr><td data-num="10"></td><td><pre>文件内容在这里...</pre></td></tr><tr><td data-num="11"></td><td><pre>------WebKitFormBoundaryABC123--</span></pre></td></tr></table></figure><blockquote>
<p><code>boundary</code>  是  <code>multipart/form-data</code>  的参数，定义用于区分请求体各个部分的分隔符。</p>
</blockquote>
<p>2、怎样去指定上传目录（如 /tmp）s，在这种情况下你有什么招能让木马文件落地在 web 目录（假设为 /var/www/html）呢？</p>
<blockquote>
<p><a target="_blank" rel="noopener" href="http://xn--onqr6jrws.sh">可以是.sh</a>,.bin,.php,.asp/aspx (windows 服务器上的同名应用程序可执行),.jsp (基于 java 的 web 程序)</p>
</blockquote>
<blockquote>
<p>路径穿越攻击</p>
<p>这是因为上面的拼接路径导致的</p>
<p>由于文件名直接拼接所以如果文件名本身是个路径，也会直接拼接进去</p>
<p>（所以可以通过构造../../../../../shell.php，不断向上层目录移动）</p>
</blockquote>
<blockquote>
<p>符号链接 (软链接) 攻击</p>
<p>类似于快捷方式</p>
<figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token function">ln</span> <span class="token parameter variable">-s</span> /var/www/html /tmp/link</pre></td></tr></table></figure><p>这样原本写入 /tmp 的会直接到 /var/www/html（要构造成 link/shell.php）</p>
</blockquote>
<blockquote>
<p>PHP 路径处理缺陷攻击</p>
<p>类似于路径穿越，但是不一定要用../，可以去敏感路径</p>
<p>包括：</p>
<ol>
<li>Web 根目录</li>
</ol>
<p>Apache 服务器</p>
<p><code>/var/www/html</code></p>
<p><code>C:\wamp\www</code> （Windows 系统使用 WampServer 时）</p>
<p>Nginx 服务器</p>
<p><code>/usr/share/nginx/html</code></p>
<ol start="2">
<li>可执行脚本目录</li>
</ol>
<p><code>/usr/local/bin</code>  或 <code>/usr/bin</code></p>
<p><code>C:\Windows\System32</code></p>
</blockquote>
<p>3、学一下 php 的 eval () 函数的用法，并写点什么好玩的～，如何在 php 中执行系统命令呢？比如 ls</p>
<blockquote>
<p>echo 不只是回显，其中的命令也会执行</p>
<p>比如 echo system ('ls -l')</p>
<p>所以......</p>
<p>system($input); &gt; shell.txt</p>
</blockquote>
<p>4、在上传文件又要传递一个 POST 参数，此时请求包的参数是什么样的？</p>
<blockquote>
<p>分割符下又多了几个，对于非文本，上面的文件内容都是二进制数据</p>
</blockquote>
<p>5、你能在 js 的层面限制只能上传图片吗？</p>
<p>使用事件侦听器</p>
<blockquote>
<figure class="highlight javascript"><figcaption data-lang="javascript"></figcaption><table><tr><td data-num="1"></td><td><pre>document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">'input[type="file"]'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'change'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="2"></td><td><pre>    <span class="token keyword">const</span> file <span class="token operator">=</span> e<span class="token punctuation">.</span>target<span class="token punctuation">.</span>files<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>file<span class="token punctuation">.</span>type<span class="token punctuation">.</span><span class="token function">startsWith</span><span class="token punctuation">(</span><span class="token string">'image/'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>        <span class="token function">alert</span><span class="token punctuation">(</span><span class="token string">'仅允许上传图片！'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>        e<span class="token punctuation">.</span>target<span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token string">''</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr></table></figure><p>startsWith: 用于匹配开头</p>
<p>e.target.files [0]:e.target 是触发的标签，files 表示其中的文件，[0] 表示第一个</p>
<p>e 是传入的事件对象 value 是选择框，最后就是清空，让用户重选</p>
</blockquote>
<blockquote>
<p>PS:&lt;input&gt; 有 accept 属性 ( <code>accept=&quot;image/*&quot;</code> )，但是可以被绕过</p>
</blockquote>
<p>另外 AI 给的玩意儿：</p>
<figure class="highlight javascript"><figcaption data-lang="javascript"></figcaption><table><tr><td data-num="1"></td><td><pre>document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">'input[type="file"]'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'change'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="2"></td><td><pre>    <span class="token keyword">const</span> file <span class="token operator">=</span> e<span class="token punctuation">.</span>target<span class="token punctuation">.</span>files<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>    <span class="token keyword">const</span> imageRegex <span class="token operator">=</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">^image\/(jpeg|png|gif|bmp)$</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>imageRegex<span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>file<span class="token punctuation">.</span>type<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>        <span class="token function">alert</span><span class="token punctuation">(</span><span class="token string">'仅允许上传 JPEG、PNG、GIF 或 BMP 格式的图片！'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>        e<span class="token punctuation">.</span>target<span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token string">''</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token comment">/*test 方法就是用来检测是否匹配正则的，^ 表示字符串开始，$ 表示结束 */</span></pre></td></tr><tr><td data-num="10"></td><td><pre>document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">'input[type="file"]'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'change'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>    <span class="token keyword">const</span> file <span class="token operator">=</span> e<span class="token punctuation">.</span>target<span class="token punctuation">.</span>files<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>    <span class="token keyword">const</span> allowedExtensions <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'.jpg'</span><span class="token punctuation">,</span> <span class="token string">'.jpeg'</span><span class="token punctuation">,</span> <span class="token string">'.png'</span><span class="token punctuation">,</span> <span class="token string">'.gif'</span><span class="token punctuation">]</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="13"></td><td><pre>    <span class="token keyword">const</span> fileExtension <span class="token operator">=</span> <span class="token string">'.'</span> <span class="token operator">+</span> file<span class="token punctuation">.</span>name<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">'.'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toLowerCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>allowedExtensions<span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span>fileExtension<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="15"></td><td><pre>        <span class="token function">alert</span><span class="token punctuation">(</span><span class="token string">'仅允许上传 JPEG、PNG 或 GIF 格式的图片！'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="16"></td><td><pre>        e<span class="token punctuation">.</span>target<span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token string">''</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="17"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="18"></td><td><pre><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr></table></figure><p>至少某个软件是使用扩展名区分的......</p>
<p>6、请你利用请求包中 Content-Type 头检测文件的是否是图片</p>
<blockquote>
<figure class="highlight php"><figcaption data-lang="PHP"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token variable">$allowed</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string single-quoted-string">'image/jpeg'</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'image/png'</span><span class="token punctuation">]</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">in_array</span><span class="token punctuation">(</span><span class="token variable">$_FILES</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'file'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'type'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token variable">$allowed</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>    <span class="token keyword">die</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'文件类型不符'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token comment">//[type] 就是返回文件的 MIME</span></pre></td></tr></table></figure></blockquote>
<p>7、常见的图片类型（jpg,png,gif）的文件头有什么特征？试着在你的防护中加入对应的检测</p>
<blockquote>
<p>jpg:FF D8 结尾是 FF D9</p>
<p>png:89 50 4E 47 0D 0A 1A 0A</p>
<p>gif:47 49 46 38 39 61 (GIF89a，但实际上后面三个是版本)</p>
</blockquote>
<figure class="highlight php"><figcaption data-lang="PHP"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">function</span> <span class="token function-definition function">checkFileHeader</span><span class="token punctuation">(</span><span class="token variable">$file</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="2"></td><td><pre>    <span class="token variable">$headers</span> <span class="token operator">=</span> <span class="token punctuation">[</span></pre></td></tr><tr><td data-num="3"></td><td><pre>        <span class="token string single-quoted-string">'jpg'</span> <span class="token operator">=></span> <span class="token string double-quoted-string">"\xFF\xD8\xFF"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="4"></td><td><pre>        <span class="token string single-quoted-string">'png'</span> <span class="token operator">=></span> <span class="token string double-quoted-string">"\x89\x50\x4E\x47"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="5"></td><td><pre>        <span class="token string single-quoted-string">'gif'</span> <span class="token operator">=></span> <span class="token string double-quoted-string">"GIF89a"</span></pre></td></tr><tr><td data-num="6"></td><td><pre>    <span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token comment">// 定义关联数组</span></pre></td></tr><tr><td data-num="7"></td><td><pre>    <span class="token variable">$content</span> <span class="token operator">=</span> <span class="token function">file_get_contents</span><span class="token punctuation">(</span><span class="token variable">$file</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>    <span class="token keyword">foreach</span> <span class="token punctuation">(</span><span class="token variable">$headers</span> <span class="token keyword">as</span> <span class="token variable">$type</span> <span class="token operator">=></span> <span class="token variable">$header</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="9"></td><td><pre>    <span class="token comment">// 这种写法适用于关联数组的遍历，as 后的就是临时变量，存储读取的键值</span></pre></td></tr><tr><td data-num="10"></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">strpos</span><span class="token punctuation">(</span><span class="token variable">$content</span><span class="token punctuation">,</span> <span class="token variable">$header</span><span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token variable">$type</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>    <span class="token punctuation">&#125;</span><span class="token comment">//strpos 用于查找字符串中首次出现指定子字符串的位置</span></pre></td></tr><tr><td data-num="13"></td><td><pre>    <span class="token comment">// 默认从零 (首位) 开始，返回数字 (第几位)，默认从头开始，也可再加参数指定</span></pre></td></tr><tr><td data-num="14"></td><td><pre>    <span class="token comment">// 没有返回 false</span></pre></td></tr><tr><td data-num="15"></td><td><pre>    <span class="token keyword">return</span> <span class="token constant boolean">false</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="16"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>8、请你写一个能够过滤.php 后缀的 waf</p>
<figure class="highlight php"><figcaption data-lang="PHP"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token variable">$filename</span><span class="token operator">=</span><span class="token variable">$_FILES</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'file'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'name'</span><span class="token punctuation">]</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token variable">$fileExtension</span><span class="token operator">=</span><span class="token function">pathinfo</span><span class="token punctuation">(</span><span class="token variable">$filename</span><span class="token punctuation">,</span><span class="token constant">PATHINFO_EXTENSION</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">strtolower</span><span class="token punctuation">(</span><span class="token variable">$fileExtension</span><span class="token punctuation">)</span><span class="token operator">===</span><span class="token string single-quoted-string">'php'</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>    <span class="token keyword">echo</span> <span class="token string single-quoted-string">'你在干什么？'</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token punctuation">&#125;</span><span class="token keyword">else</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>    <span class="token function">move_uploaded_file</span><span class="token punctuation">(</span><span class="token variable">$file</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'tmp_name'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'uploaded/'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>    <span class="token keyword">echo</span> <span class="token string single-quoted-string">'是的，就是这样。'</span></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token comment">/*pathinfo (string $path, int $options)</pre></td></tr><tr><td data-num="10"></td><td><pre>options 可选：</pre></td></tr><tr><td data-num="11"></td><td><pre>PATHINFO_DIRNAME：返回文件所在的目录名。</pre></td></tr><tr><td data-num="12"></td><td><pre>PATHINFO_BASENAME：返回文件的基本名称（包含扩展名）。</pre></td></tr><tr><td data-num="13"></td><td><pre>PATHINFO_EXTENSION：返回文件的扩展名。</pre></td></tr><tr><td data-num="14"></td><td><pre>PATHINFO_FILENAME：返回文件的基本名称（不包含扩展名）</pre></td></tr><tr><td data-num="15"></td><td><pre></pre></td></tr><tr><td data-num="16"></td><td><pre>不指定 option 返回关联数组，否则字符串 */</span></pre></td></tr><tr><td data-num="17"></td><td><pre>不如直接判断<span class="token constant">MIME</span>（application<span class="token operator">/</span>x<span class="token operator">-</span>php或者text<span class="token operator">/</span>x<span class="token operator">-</span>php）</pre></td></tr><tr><td data-num="18"></td><td><pre>有时也用<span class="token function">file</span><span class="token punctuation">(</span><span class="token variable">$_FILES</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'file'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'tmp_name'</span><span class="token punctuation">]</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="19"></td><td><pre>而不是<span class="token variable">$_FILES</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'file'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'type'</span><span class="token punctuation">]</span></pre></td></tr><tr><td data-num="20"></td><td><pre>来获取<span class="token constant">MIME</span></pre></td></tr><tr><td data-num="21"></td><td><pre>但是<span class="token constant">MIME</span>可以伪造</pre></td></tr></table></figure><p>9、请你使用 file_put_content () 来实现一次文件上传到指定目录</p>
<figure class="highlight php"><figcaption data-lang="PHP"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token function">file_put_contents</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'uploads/'</span><span class="token operator">.</span><span class="token variable">$_FILES</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'file'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'name'</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token function">file_get_contents</span><span class="token punctuation">(</span><span class="token variable">$_FILES</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'file'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'tmp_name'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr></table></figure><p>10、文件上传除了导致 php 代码执行，还可能导致什么漏洞？</p>
<blockquote>
<p>任意文件覆盖漏洞，目录遍历漏洞（要能路径穿越），拒绝服务（DoS）攻击（上传大量垃圾），XSS（存储型），文件包含漏洞（上传包含恶意代码的 PHP 文件，然后构造请求让程序包含这个恶意文件，需要页面本身会动态包含上传文件）</p>
</blockquote>
<p>11、为后续做个铺垫，请你想办法捕捉到文件上传瞬间临时目录（Linux 下是 /tmp）下的文件变化（动作要快，姿势要帅，临时文件消失快）</p>
<p>使用 inotify 监控 /tmp 目录</p>
<figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token function">sudo</span> <span class="token function">apt</span> <span class="token function">install</span> inotify-too <span class="token comment">#安装</span></pre></td></tr><tr><td data-num="2"></td><td><pre>inotifywait <span class="token parameter variable">-m</span> <span class="token parameter variable">-e</span> create /tmp   <span class="token comment">#监控目录文件创建事件</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token comment">#-m 持续监控，而不是一个就退出</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token comment">#-e create 指定监控的事件为创建</span></pre></td></tr></table></figure><h2 id="文件上传"><a class="anchor" href="#文件上传">#</a> 文件上传</h2>
<p><img loading="lazy" data-src="1739202184876.png" alt="1739202184876" /></p>
<p><img loading="lazy" data-src="1739202230914.png" alt="1739202230914" /></p>
<p><img loading="lazy" data-src="1739202984987.png" alt="1739202984987" /></p>
<p><img loading="lazy" data-src="1739203097971.png" alt="1739203097971" /></p>
<blockquote>
<p>临时的副本文件会在脚本结束时消失。</p>
<p>要保存被上传的文件，需要用 PHP 的 copy () 函数将它复制到其它位置</p>
</blockquote>
<p>其他：</p>
<blockquote>
<p><strong>$_FILES 数组内容如下:</strong></p>
<p>$_FILES ['myFile']['name'] 客户端文件的原名称。</p>
<p>$_FILES ['myFile']['type'] 文件的 MIME 类型，需要浏览器提供该信息的支持，例如 &quot;image/gif&quot;。</p>
<p>$_FILES ['myFile']['size'] 已上传文件的大小，单位为字节。</p>
<p>$_FILES ['myFile']['tmp_name'] 文件被上传后在服务端储存的临时文件名，一般是系统默认。可以在 php.ini 的 upload_tmp_dir 指定，但 用 putenv () 函数设置是不起作用的。</p>
<p>$_FILES ['myFile']['error'] 和该文件上传相关的错误代码。['error'] 是在 PHP 4.2.0 版本中增加的。下面是它的说明：(它们在 PHP 4.3.0 之后变成了 PHP 常量。)</p>
<figure class="highlight php"><figcaption data-lang="PHP"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token constant">UPLOAD_ERR_OK</span> <span class="token operator">-</span> 值：<span class="token number">0</span><span class="token punctuation">;</span> 没有错误发生，文件上传成功。 </pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token constant">UPLOAD_ERR_INI_SIZE</span> <span class="token operator">-</span> 值：<span class="token number">1</span><span class="token punctuation">;</span> 上传的文件超过了 php<span class="token operator">.</span>ini 中 upload_max_filesize 选项限制的值。 </pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token constant">UPLOAD_ERR_FORM_SIZE</span> <span class="token operator">-</span> 值：<span class="token number">2</span><span class="token punctuation">;</span> 上传文件的大小超过了 <span class="token constant">HTML</span> 表单中 <span class="token constant">MAX_FILE_SIZE</span> 选项指定的值。 </pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token constant">UPLOAD_ERR_PARTIAL</span> <span class="token operator">-</span> 值：<span class="token number">3</span><span class="token punctuation">;</span> 文件只有部分被上传。 </pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token constant">UPLOAD_ERR_NO_FILE</span> <span class="token operator">-</span> 值：<span class="token number">4</span><span class="token punctuation">;</span> 没有文件被上传。 </pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token constant">UPLOAD_ERR_NO_TMP_DIR</span> <span class="token operator">-</span>其值为 <span class="token number">6</span>，找不到临时文件夹。<span class="token constant">PHP</span> <span class="token number">4.3</span><span class="token number">.10</span> 和 <span class="token constant">PHP</span> <span class="token number">5.0</span><span class="token number">.3</span> 引进。</pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token constant">UPLOAD_ERR_CANT_WRITE</span> <span class="token operator">-</span> 其值为 <span class="token number">7</span>，文件写入失败。<span class="token constant">PHP</span> <span class="token number">5.1</span><span class="token number">.0</span> 引进。</pre></td></tr></table></figure></blockquote>
<h2 id="漏洞"><a class="anchor" href="#漏洞">#</a> 漏洞</h2>
<h3 id="扩展名"><a class="anchor" href="#扩展名">#</a> 扩展名</h3>
<p>一个前端的限制：</p>
<blockquote>
<p><img loading="lazy" data-src="1739263171554.png" alt="1739263171554" /></p>
</blockquote>
<p>可以抓包改后缀 / 禁用 JS 来绕过～</p>
<p>后端的限制，可以黑 / 白名单：</p>
<figure class="highlight php"><figcaption data-lang="PHP"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token variable">$temp</span><span class="token operator">=</span><span class="token function">explode</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"."</span><span class="token punctuation">,</span><span class="token variable">$_FILE</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'file'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'name'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token variable">$file_ext</span><span class="token operator">=</span><span class="token function">end</span><span class="token punctuation">(</span>temp<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token variable">$allow_ext</span><span class="token operator">=</span><span class="token keyword">array</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'php'</span><span class="token punctuation">,</span><span class="token string single-quoted-string">'asp'</span><span class="token punctuation">,</span><span class="token string single-quoted-string">'aspx'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">in_array</span><span class="token punctuation">(</span><span class="token function">strtolower</span><span class="token punctuation">(</span><span class="token variable">$file_ext</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token variable">$allow_ext</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>    <span class="token keyword">echo</span> <span class="token string single-quoted-string">'POTATOWO'</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>    <span class="token function">move_uploaded_file</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'uploads/'</span><span class="token operator">.</span><span class="token variable">$_FILES</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'file'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'name'</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token variable">$_FILES</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'file'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'temp_name'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token punctuation">&#125;</span><span class="token keyword">else</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>    <span class="token keyword">echo</span> <span class="token string single-quoted-string">'还是太善良了'</span></pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>然后是 CSDN 上的：</p>
<p><img loading="lazy" data-src="1739264583886.png" alt="1739264583886" /></p>
<p>trim (): 用于去除字符串首尾的字符，默认是去空格，它在 JS 中是一个方法</p>
<p>欸？为什么不用 pathinfo 呢？我也不清楚</p>
<h3 id="mime"><a class="anchor" href="#mime">#</a> MIME</h3>
<p>上面说了。可以伪造，用 bp 修改 header</p>
<h3 id="文件头"><a class="anchor" href="#文件头">#</a> 文件头</h3>
<p>幻术头字节是文件头的一部分，用于表示文件类型，文件头本身可能包含其他信息，比如图片的位深等</p>
<h4 id="常见的"><a class="anchor" href="#常见的">#</a> 常见的</h4>
<blockquote>
<p><img loading="lazy" data-src="1739265242140.png" alt="1739265242140" /></p>
</blockquote>
<p><strong>绕过</strong></p>
<p>对于 PHP 的文件由于 &lt;?php ...php&gt; 之前的都会被当成 html，所以写 php 文件前先乱写点什么</p>
<h2 id="文件包含"><a class="anchor" href="#文件包含">#</a> 文件包含</h2>
<p>注入型漏洞</p>
<p>包含是指调用被写在单个文件中的可重复使用函数</p>
<p>漏洞出现于用户可选要包含的文件</p>
<p>攻击者修改文件位置来执行任意文件</p>
<h3 id="常用的函数"><a class="anchor" href="#常用的函数">#</a> 常用的函数</h3>
<ul>
<li>require (): 找不到被包含的文件会产生致命错误，并停止脚本运行</li>
<li>include (): 找不到被包含的文件只会产生警告，脚本继续执行</li>
<li>require_once () 与 require () 类似：唯一的区别是如果该文件的代码已经被包含，则不会再次包含</li>
<li>include_once () 与 include () 类似：唯一的区别是如果该文件的代码已经被包含，则不会再次包含</li>
</ul>
<p>它们的参数都是路径</p>
<p>对于 PHP 来说，无论执行的文件是什么玩意儿，<strong>只要其中有 PHP 代码，就会执行</strong></p>
<h3 id="本地文件包含lfi"><a class="anchor" href="#本地文件包含lfi">#</a> 本地文件包含（LFI）</h3>
<p>就是打开本地的文件，可以用于获取敏感信息</p>
<p>例如：</p>
<p><img loading="lazy" data-src="1739611330897.png" alt="1739611330897" /></p>
<p>显而易见，你可以用来执行文件上传漏洞的 webshell</p>
<p>你可以它放在被包含的路径上</p>
<h3 id="包含apache日志文件"><a class="anchor" href="#包含apache日志文件">#</a> 包含 Apache 日志文件</h3>
<blockquote>
<p>如果没有上传但是包含，而且<strong>日志可读且已知路径</strong></p>
</blockquote>
<p>每次访问的 url 都会被记录到 access.log</p>
<p>发生错误就记录到 error.log</p>
<p>你可以在 url 中写 PHP 让它记录下来</p>
<p>（注意：会被编码，记得 bp 抓包改报文）</p>
<p>然后包含该日志</p>
<p>有趣的是，执行的结果会替换在日志中的对应语句的 url 中（存疑）</p>
<h3 id="包含session文件"><a class="anchor" href="#包含session文件">#</a> 包含 SESSION 文件</h3>
<blockquote>
<p>SESSION 中有可控变量，并且可以读写，知道路径</p>
</blockquote>
<p><img loading="lazy" data-src="1739612579792.png" alt="1739612579792" /></p>
<h3 id="包含临时文件"><a class="anchor" href="#包含临时文件">#</a> 包含临时文件</h3>
<p>就是传说中的上传后的临时文件</p>
<p>Linux 是 /tmp</p>
<p>Windows 是 C:\windows\temp</p>
<p>因为 Linux 的随机函数有缺陷，windows 只要 65535 种情况，所以一般暴力猜解</p>
<p>文件名</p>
<p>也可以看 phpinfo 页面的 php variables 直接获取上传文件的存储路径和临时文件名</p>
<p>---- 但是必须在该 PHP 文件执行结束前就完成所有操作</p>
<h3 id="远程文件包含rfi"><a class="anchor" href="#远程文件包含rfi">#</a> 远程文件包含（RFI）</h3>
<p>需要配置选项 <code>allow_url_include</code>  和 <code>allow_url_fopen</code>  状态为 on</p>
<p>反正就是可以包含其他服务器上的文件</p>
<p>你可以用 %00 (php 版本小于 5.3.4) 或者？来截断 url</p>
<p>（如果有需要去掉后端本身可能存在的拼接内容）</p>
<h3 id="php伪协议"><a class="anchor" href="#php伪协议">#</a> PHP 伪协议</h3>
<h4 id="file"><a class="anchor" href="#file">#</a> file://</h4>
<p>访问本地文件，<strong>不受 allow_url_fopen/include 影响</strong></p>
<p>需要绝对路径（包括文件名）</p>
<h4 id="php"><a class="anchor" href="#php">#</a> php://</h4>
<p>访问输入输出流</p>
<p>php://filter 读取源代码，base64 输出 (不这样会被直接执行，当你访问文件时)</p>
<p>php://input 执行 php 代码（具体代码是请求体中的，不是 url，自己用 bp 加，需要 &lt;&gt;）</p>
<p><strong>不受 allow_url_fopen/include 影响</strong>（input 要求 include 是 on）</p>
<h4 id="zip"><a class="anchor" href="#zip">#</a> ZIP://</h4>
<p>访问压缩包里的文件，只能绝对路径</p>
<p>分割符（分割路径和包内文件） <code>#</code> 要用 url 编码成 %23</p>
<p><strong>不受 allow_url_fopen/include 影响</strong></p>
<p>类似的：</p>
<p>zlib://，bzip2://</p>
<p><strong>无所谓后缀名</strong></p>
<h4 id="data"><a class="anchor" href="#data">#</a> data://</h4>
<p>类似于 php://input，但是</p>
<p><strong>allow_url_fopen/include 必须都是 on</strong></p>
<p><img loading="lazy" data-src="1739619725310.png" alt="1739619725310" /></p>
</div><footer><div class="meta"><span class="item"><span class="icon"><i class="ic i-calendar-check"></i></span><span class="text">編集日</span><time title="修正日：2025-03-08 16:48:28" itemprop="dateModified" datetime="2025-03-08T16:48:28+08:00">2025-03-08</time></span></div><div id="copyright"><ul><li class="author"><strong>著者：</strong>owotatop<i class="ic i-at"><em>@</em></i>这就是--Potato</li><li class="link"><strong>記事へのリンク：</strong><a href="https://zhewanyiershinicheng.github.io/2025/02/15/%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0/" title="文件上传漏洞">https://zhewanyiershinicheng.github.io/2025/02/15/文件上传/</a></li><li class="license"><strong>著作権表示：</strong>このブログ内のすべての記事は、特別な記載がない限り <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh"><i class="ic i-creative-commons"><em>(CC)</em></i>BY-NC-SA</a> の下のライセンスで保護されています。</li></ul></div></footer></article></div><div class="post-nav"><div class="item left"><a href="/2025/02/05/XSS/" rel="prev" itemprop="url" title="XSS" style="background-image: linear-gradient(to bottom right, #ece8d5, #ccbcea);"><span class="type">前の記事</span><span class="category"><i class="ic i-flag"></i>技术</span><h3>XSS</h3></a></div><div class="item right"><a href="/2025/03/20/flask/" rel="next" itemprop="url" title="flask" style="background-image: linear-gradient(to bottom right, #caceb4, #c8a68d);"><span class="type">次の記事</span><h3>flask</h3></a></div></div><div class="wrap" id="comments"></div></div><div id="sidebar"><div class="inner"><div class="panels"><div class="inner"><div class="contents panel pjax" data-title="見出し"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%96%87%E4%BB%B6"><span class="toc-number">1.</span> <span class="toc-text"> 文件</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%A5%87%E6%80%AA%E7%9A%84%E8%A6%81%E6%B1%82~"><span class="toc-number">1.1.</span> <span class="toc-text"> 奇怪的要求～</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0"><span class="toc-number">1.2.</span> <span class="toc-text"> 文件上传</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E"><span class="toc-number">1.3.</span> <span class="toc-text"> 漏洞</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%89%A9%E5%B1%95%E5%90%8D"><span class="toc-number">1.3.1.</span> <span class="toc-text"> 扩展名</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#mime"><span class="toc-number">1.3.2.</span> <span class="toc-text"> MIME</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%96%87%E4%BB%B6%E5%A4%B4"><span class="toc-number">1.3.3.</span> <span class="toc-text"> 文件头</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%B8%B8%E8%A7%81%E7%9A%84"><span class="toc-number">1.3.3.1.</span> <span class="toc-text"> 常见的</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%96%87%E4%BB%B6%E5%8C%85%E5%90%AB"><span class="toc-number">1.4.</span> <span class="toc-text"> 文件包含</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%B8%B8%E7%94%A8%E7%9A%84%E5%87%BD%E6%95%B0"><span class="toc-number">1.4.1.</span> <span class="toc-text"> 常用的函数</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9C%AC%E5%9C%B0%E6%96%87%E4%BB%B6%E5%8C%85%E5%90%ABlfi"><span class="toc-number">1.4.2.</span> <span class="toc-text"> 本地文件包含（LFI）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8C%85%E5%90%ABapache%E6%97%A5%E5%BF%97%E6%96%87%E4%BB%B6"><span class="toc-number">1.4.3.</span> <span class="toc-text"> 包含 Apache 日志文件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8C%85%E5%90%ABsession%E6%96%87%E4%BB%B6"><span class="toc-number">1.4.4.</span> <span class="toc-text"> 包含 SESSION 文件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8C%85%E5%90%AB%E4%B8%B4%E6%97%B6%E6%96%87%E4%BB%B6"><span class="toc-number">1.4.5.</span> <span class="toc-text"> 包含临时文件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%BF%9C%E7%A8%8B%E6%96%87%E4%BB%B6%E5%8C%85%E5%90%ABrfi"><span class="toc-number">1.4.6.</span> <span class="toc-text"> 远程文件包含（RFI）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#php%E4%BC%AA%E5%8D%8F%E8%AE%AE"><span class="toc-number">1.4.7.</span> <span class="toc-text"> PHP 伪协议</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#file"><span class="toc-number">1.4.7.1.</span> <span class="toc-text"> file:&#x2F;&#x2F;</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#php"><span class="toc-number">1.4.7.2.</span> <span class="toc-text"> php:&#x2F;&#x2F;</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#zip"><span class="toc-number">1.4.7.3.</span> <span class="toc-text"> ZIP:&#x2F;&#x2F;</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#data"><span class="toc-number">1.4.7.4.</span> <span class="toc-text"> data:&#x2F;&#x2F;</span></a></li></ol></li></ol></li></ol></li></ol></div><div class="related panel pjax" data-title="関連記事"><ul><li ><a href="/2024/10/11/MySQL/" rel="bookmark" title="MySQL">MySQL</a></li><li ><a href="/2024/10/11/%E6%B1%87%E7%BC%96/" rel="bookmark" title="汇编">汇编</a></li><li ><a href="/2024/10/14/C%E7%AC%94%E8%AE%B01ultrasuper/" rel="bookmark" title="C笔记ultra">C笔记ultra</a></li><li ><a href="/2024/10/14/IDA%E7%9A%84%E4%BD%BF%E7%94%A8/" rel="bookmark" title="IDA">IDA</a></li><li ><a href="/2024/10/14/HTML/" rel="bookmark" title="HTML">HTML</a></li><li ><a href="/2024/10/14/C%E7%AC%94%E8%AE%B02SE/" rel="bookmark" title="C笔记2SE">C笔记2SE</a></li><li ><a href="/2024/10/14/JavaScript/" rel="bookmark" title="JavaScript">JavaScript</a></li><li ><a href="/2025/01/22/Linux/" rel="bookmark" title="Linux">Linux</a></li><li ><a href="/2025/02/04/SQL%E6%B3%A8%E5%85%A5/" rel="bookmark" title="SQL注入">SQL注入</a></li><li ><a href="/2025/02/05/XSS/" rel="bookmark" title="XSS">XSS</a></li><li  class="active"><a href="/2025/02/15/%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0/" rel="bookmark" title="文件上传漏洞">文件上传漏洞</a></li></ul></div><div class="overview panel" data-title="概要"><div class="author" itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><img class="image" loading="lazy" decoding="async" itemprop="image" alt="开船的" src="/assets/avatar.jpg"/><p class="name" itemprop="name">开船的</p><div class="description" itemprop="description">bug依旧很多，反正我忍不了</div></div><nav class="state"><div class="item posts"><a href="/archives/"><span class="count">19</span><span class="name">ポスト</span></a></div><div class="item categories"><a href="/categories/"><span class="count">3</span><span class="name">カテゴリ</span></a></div><div class="item tags"><a href="/tags/"><span class="count">4</span><span class="name">タグ</span></a></div></nav><div class="social"><a target="_blank" rel="noopener" href="https://github.com/zhewanyiershinicheng" class="item github" title="https:&#x2F;&#x2F;github.com&#x2F;zhewanyiershinicheng"><i class="ic i-github"></i></a></div><div class="menu"><li class="item"><a href="/" rel="section"><i class="ic i-home"></i>ホーム</a></li><li class="item dropdown"><a href="#" onclick="return false;"><i class="ic i-feather"></i>投稿</a><ul class="submenu"><li class="item"><a href="/archives/" rel="section"><i class="ic i-list-alt"></i>アーカイブ</a></li><li class="item"><a href="/categories/" rel="section"><i class="ic i-th"></i>カテゴリ</a></li><li class="item"><a href="/tags/" rel="section"><i class="ic i-tags"></i>タグ</a></li></ul></li><li class="item"><a href="/friends/" rel="section"><i class="ic i-heart"></i>フレンド</a></li></div></div></div></div><ul id="quick"><li class="prev pjax"><a href="/2025/03/20/flask/" rel="prev" title="前の記事"><i class="ic i-chevron-left"></i></a></li><li class="up"><i class="ic i-arrow-up"></i></li><li class="down"><i class="ic i-arrow-down"></i></li><li class="next pjax"><a href="/2025/02/05/XSS/" rel="next" title="次の記事"><i class="ic i-chevron-right"></i></a></li><li class="percent"></li></ul></div></div><div class="dimmer"></div></div></main><footer id="footer"><div class="inner"><div class="widgets"><div class="rpost pjax"><h2>ランダムな記事</h2><ul><li class="item"><div class="breadcrumb"><a href="/categories/%E6%8A%80%E6%9C%AF/" title="カテゴリ技术">技术</a></div><span><a href="/2025/02/15/%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0/">文件上传漏洞</a></span></li><li class="item"><div class="breadcrumb"></div><span><a href="/2025/03/22/%E4%B8%80%E7%82%B9C-%E7%9A%84%E7%A2%8E%E7%A2%8E%E5%BF%B5/">一点C-的碎碎念</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/%E6%8A%80%E6%9C%AF/" title="カテゴリ技术">技术</a></div><span><a href="/2024/10/14/JavaScript/">JavaScript</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/%E7%A6%BB%E8%B0%B1/" title="カテゴリ离谱">离谱</a></div><span><a href="/2024/10/15/%E4%B8%8D%E6%98%AF%EF%BC%8C%E5%BE%AE%E8%BD%AF%EF%BC%8C%E4%BD%A0%E6%9D%A5%E7%9C%9F%E7%9A%84%EF%BC%9F/">不是，微软，你来真的？</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/%E7%A6%BB%E8%B0%B1/" title="カテゴリ离谱">离谱</a></div><span><a href="/2024/10/11/%E5%9C%9F%E8%B1%86%E8%B1%86%E8%B1%86%E8%B1%86%E8%B1%86/">土豆豆豆豆豆</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/%E6%8A%80%E6%9C%AF/" title="カテゴリ技术">技术</a></div><span><a href="/2025/01/22/Linux/">Linux</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/%E6%8A%80%E6%9C%AF/" title="カテゴリ技术">技术</a></div><span><a href="/2024/10/14/C%E7%AC%94%E8%AE%B02SE/">C笔记2SE</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/%E6%8A%80%E6%9C%AF/" title="カテゴリ技术">技术</a></div><span><a href="/2025/02/04/SQL%E6%B3%A8%E5%85%A5/">SQL注入</a></span></li><li class="item"><div class="breadcrumb"></div><span><a href="/2025/03/28/docker/">docker</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/%E6%8A%80%E6%9C%AF/" title="カテゴリ技术">技术</a></div><span><a href="/2024/10/14/IDA%E7%9A%84%E4%BD%BF%E7%94%A8/">IDA</a></span></li></ul></div><div class="rpost pjax"><h2>最近のコメント</h2></div></div><div class="status"><div class="copyright">&copy; 2022 -<span itemprop="copyrightYear">2025</span><span class="with-love"><i class="ic i-sakura rotate"></i></span><span class="author" itemprop="copyrightHolder">开船的 @ chongkai</span></div><div class="count"><span class="post-meta-item-icon"><i class="ic i-chart-area"></i></span><span title="単語の総数">140k 単語</span><span class="post-meta-divider"> | </span><span class="post-meta-item-icon"><i class="ic i-coffee"></i></span><span title="読書の合計時間">2:07</span></div><div class="powered-by">Powered by <a target="_blank" rel="noopener" href="https://hexo.io/">Hexo</a> & Theme.<a target="_blank" rel="noopener" href="https://github.com/theme-shoka-x/hexo-theme-shokaX/">ShokaX</a></div></div></div></footer></div><script data-config type="text/javascript">var LOCAL = {
    ispost: true,
        path: `2025/02/15/文件上传/`,
        favicon: {
        show: `（●´3｀●）やれやれだぜ`,
        hide: `(´Д｀)大変だ！`
    },
    search: {
        placeholder: "検索…",
        empty: "「 ${query} 」については何も見つかりませんでした",
        stats: "${time} ms以内に ${hits} 件の結果が見つかりました"
    },
    copy_tex: false,
    katex: false,
    mermaid: false,
    audio: undefined,
    fancybox: true,
    nocopy: false,
    outime: true,
    template: `<div class="note warning"><p><span class="label warning">記事の適時性の警告</span><br> {{publish}} 日前に公開され、 {{updated}} 日前に最終更新された記事です。 一部情報が変更されている可能性がありますので、ご了承ください。</p></div>`,
    quiz: {
        choice: `選択`,
        multiple: `複数選択`,
        true_false: `正誤`,
        essay: `問答`,
        gap_fill: `空欄`,
        mistake: `間違った答え`
    },
    ignores: [
        (uri) => uri.includes('#'),
        (uri) => new RegExp(LOCAL.path + '$').test(uri),
            []
    ]
};
</script><script src="https://s4.zstatic.net/ajax/libs/pace/1.2.4/pace.min.js" integrity="sha384-k6YtvFUEIuEFBdrLKJ3YAUbBki333tj1CSUisai5Cswsg9wcLNaPzsTHDswp4Az8" crossorigin="anonymous" fetchpriority="high"></script><script src="https://s4.zstatic.net/ajax/libs/jquery/3.5.1/jquery.min.js" integrity="sha384-ZvpUoO&#x2F;+PpLXR1lu4jmpXWu80pZlYUAfxl5NsBMWOEPSjUn&#x2F;6Z&#x2F;hRTt8+pR6L4N2" crossorigin="anonymous" fetchpriority="high"></script><script src="/js/siteInit.js?v=0.4.17" type="module" fetchpriority="high" defer></script></body></html>